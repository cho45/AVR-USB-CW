<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

		<script type="text/javascript" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

		<link rev="made" href="mailto:cho45@lowreal.net"/>
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>

		<!--[if lt IE 9]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	</head>
	<body>
		<div class="container">
			<div class="page-header">
				<h1></h1>
				<p class="lead"></p>
			</div>

			<div id="footer">
				<address>2014 <a href="mailto:cho45@lowreal.net">cho45@lowreal.net</a></address>
			</div>
		</div>

		<script>
			var service = {};
			service.request_id = 0;

			service.connect = function () {
				service.socket = new WebSocket("ws://localhost:51234");

				service.socket.onopen = function () {
					console.log('onopen');
				};

				service.socket.onclose = function () {
					console.log('onclose');
					delete service.socket;
					setTimeout(function () {
						console.log('reconnecting');
						service.connect();
					}, 1000);
				};

				service.socket.onmessage = function (e) {
					var data = JSON.parse(e.data);
					console.log('ws.onmessage', data);
					if (typeof data.id == 'number') {
						if (service.command.callbacks[data.id]) {
							service.command.callbacks[data.id](data);
						} else {
							console.log('unknown id');
						}
					} else {
						console.log(data.result.event, data.result.value);
					}
				};

			};

			service.command = function (method, params) {
				var id = service.request_id++;
				service.command.callbacks[id] = function (data) {
					delete service.command.callbacks[id];
					console.log(data.result);
				};
				service.socket.send(JSON.stringify({
					method : method,
					params : params,
					id     : id
				}));
			};
			service.command.callbacks = {};

			service.connect();
		</script>
	</body>
</html>
